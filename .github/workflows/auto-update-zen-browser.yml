name: Auto-update zen-browser-bin

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: overlay-updates
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for new release
        id: check
        run: |
          LATEST=$(curl -s https://api.github.com/repos/zen-browser/desktop/releases/latest | jq -r .tag_name)
          
          if ls www-client/zen-browser-bin/zen-browser-bin-*.ebuild 1> /dev/null 2>&1; then
            CURRENT=$(ls www-client/zen-browser-bin/zen-browser-bin-*.ebuild | \
              sed -n 's/.*zen-browser-bin-\([0-9][^-]*\)\(-r[0-9]*\)\?\.ebuild/\1/p' | \
              sort -V | tail -1)
          else
            CURRENT=""
          fi

          echo "Latest: $LATEST, Current: $CURRENT"

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "update-needed=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST" >> $GITHUB_OUTPUT
          else
            echo "update-needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate ebuild and manifest
        if: steps.check.outputs.update-needed == 'true'
        run: |
          cd www-client/zen-browser-bin/
          VERSION=${{ steps.check.outputs.version }}
          
          LATEST_EBUILD=$(ls zen-browser-bin-*.ebuild | sort -V | tail -1)
          cp "$LATEST_EBUILD" "zen-browser-bin-${VERSION}.ebuild"

          wget -q -O /tmp/amd64.tar.xz "https://github.com/zen-browser/desktop/releases/download/${VERSION}/zen.linux-x86_64.tar.xz"
          wget -q -O /tmp/arm64.tar.xz "https://github.com/zen-browser/desktop/releases/download/${VERSION}/zen.linux-aarch64.tar.xz"

          AMD64_SIZE=$(stat -c%s /tmp/amd64.tar.xz)
          AMD64_BLAKE2B=$(b2sum /tmp/amd64.tar.xz | awk '{print $1}')
          AMD64_SHA512=$(sha512sum /tmp/amd64.tar.xz | awk '{print $1}')

          ARM64_SIZE=$(stat -c%s /tmp/arm64.tar.xz)
          ARM64_BLAKE2B=$(b2sum /tmp/arm64.tar.xz | awk '{print $1}')
          ARM64_SHA512=$(sha512sum /tmp/arm64.tar.xz | awk '{print $1}')

          cat >> Manifest << EOF
          DIST zen-browser-bin-${VERSION}-x86_64.tar.xz ${AMD64_SIZE} BLAKE2B ${AMD64_BLAKE2B} SHA512 ${AMD64_SHA512}
          DIST zen-browser-bin-${VERSION}-aarch64.tar.xz ${ARM64_SIZE} BLAKE2B ${ARM64_BLAKE2B} SHA512 ${ARM64_SHA512}
          EOF

          rm -f /tmp/amd64.tar.xz /tmp/arm64.tar.xz

      - name: Commit and push
        if: steps.check.outputs.update-needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "www-client/zen-browser-bin: bump to ${{ steps.check.outputs.version }}"
          git pull --rebase origin main
          git push
