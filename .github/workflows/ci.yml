name: Gentoo Overlay QA

on:
  pull_request:
  push:
    branches: [main]

jobs:
  pkgcheck:
    runs-on: ubuntu-latest
    container:
      image: gentoo/stage3:latest
    steps:
      - uses: actions/checkout@v4.2.2

      - name: Setup Portage for binary packages
        run: |
          # Configure Portage for binary packages
          mkdir -p /etc/portage/binrepos.conf

          # Disable binary package signature verification in CI
          cat > /etc/portage/binrepos.conf/gentoobinhost.conf <<EOF
[gentoobinhost]
priority = 9999
sync-uri = https://distfiles.gentoo.org/releases/amd64/binpackages/23.0/x86-64-v3/
gpg-verify = no
EOF

          # Enable binary package features
          echo 'FEATURES="${FEATURES} binpkg-multi-instance getbinpkg"' >> /etc/portage/make.conf
          echo 'EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --binpkg-respect-use=y --usepkg=y --getbinpkg=y"' >> /etc/portage/make.conf
          echo 'GENTOO_MIRRORS="https://distfiles.gentoo.org"' >> /etc/portage/make.conf

      - name: Cache Portage packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/binpkgs
            /var/db/repos/gentoo
          key: gentoo-pkgcheck-${{ runner.os }}-${{ hashFiles('**/ci.yml') }}
          restore-keys: |
            gentoo-pkgcheck-${{ runner.os }}-

      - name: Update Portage
        run: |
          emerge-webrsync

      - name: Install QA tools
        run: |
          # Try to use binary packages, fall back to building if needed
          emerge -q --usepkg --getbinpkg dev-util/pkgcheck dev-util/pkgdev || \
          emerge -q dev-util/pkgcheck dev-util/pkgdev

      - name: Run pkgcheck
        run: |
          # Run pkgcheck but only report, don't fail
          pkgcheck scan --net || true

          echo ""
          echo "QA check completed. Review warnings above."
          echo "To see only errors: pkgcheck scan --exit error"
