name: Auto-update vesktop-bin

on:
  schedule:
    - cron: '30 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: overlay-updates
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for new release
        id: check
        run: |
          LATEST=$(curl -s https://api.github.com/repos/Vencord/Vesktop/releases/latest | jq -r .tag_name | sed 's/^v//')
          
          if ls net-im/vesktop-bin/vesktop-bin-*.ebuild 1> /dev/null 2>&1; then
            CURRENT=$(ls net-im/vesktop-bin/vesktop-bin-*.ebuild | sed 's/.*vesktop-bin-\(.*\)\.ebuild/\1/' | sort -V | tail -1)
          else
            CURRENT=""
          fi

          echo "Latest: $LATEST, Current: $CURRENT"

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "update-needed=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST" >> $GITHUB_OUTPUT
          else
            echo "update-needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate ebuild and manifest
        if: steps.check.outputs.update-needed == 'true'
        run: |
          cd net-im/vesktop-bin/
          VERSION=${{ steps.check.outputs.version }}
          
          LATEST_EBUILD=$(ls vesktop-bin-*.ebuild | sort -V | tail -1)
          cp "$LATEST_EBUILD" "vesktop-bin-${VERSION}.ebuild"

          wget -q -O /tmp/amd64.tar.gz "https://github.com/Vencord/Vesktop/releases/download/v${VERSION}/vesktop-${VERSION}.tar.gz"
          wget -q -O /tmp/arm64.tar.gz "https://github.com/Vencord/Vesktop/releases/download/v${VERSION}/vesktop-${VERSION}-arm64.tar.gz"

          AMD64_SIZE=$(stat -c%s /tmp/amd64.tar.gz)
          AMD64_BLAKE2B=$(b2sum /tmp/amd64.tar.gz | awk '{print $1}')
          AMD64_SHA512=$(sha512sum /tmp/amd64.tar.gz | awk '{print $1}')

          ARM64_SIZE=$(stat -c%s /tmp/arm64.tar.gz)
          ARM64_BLAKE2B=$(b2sum /tmp/arm64.tar.gz | awk '{print $1}')
          ARM64_SHA512=$(sha512sum /tmp/arm64.tar.gz | awk '{print $1}')

          cat >> Manifest << EOF
          DIST vesktop-${VERSION}.tar.gz ${AMD64_SIZE} BLAKE2B ${AMD64_BLAKE2B} SHA512 ${AMD64_SHA512}
          DIST vesktop-${VERSION}-arm64.tar.gz ${ARM64_SIZE} BLAKE2B ${ARM64_BLAKE2B} SHA512 ${ARM64_SHA512}
          EOF

          rm -f /tmp/amd64.tar.gz /tmp/arm64.tar.gz

      - name: Commit and push
        if: steps.check.outputs.update-needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "net-im/vesktop-bin: bump to ${{ steps.check.outputs.version }}"
          git pull --rebase origin main
          git push
